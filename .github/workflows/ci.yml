# This is a GitHub Actions workflow for Continuous Integration (CI)
# It runs automatically every time you do 'push' or a 'pull request'.

name: CI (Code Testing and Linting)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-and-lint:
    # Use the latest version of Ubuntu
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # Test only with Python 3.10, which is the version we defined
        python-version: ["3.10"] 

    steps:
    # Step 1: Download the code from the repository
    - name: 1. Checkout (Download code)
      uses: actions/checkout@v4

    # Step 2: Configure Python environment
    - name: 2. Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    # Step 3: Install dependencies
    - name: 3. Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install flake8 for linting (style checking)
        pip install flake8
        # Install app dependencies (CPU version)
        pip install -r requirements.txt

    # Step 4: Linting with flake8
    - name: 4. Lint with flake8
      run: |
        # Check code for style or syntax errors.
        # --count: Show total number of errors
        # --select=E9,F63,F7,F82: Report only serious errors (syntax, undefined variables)
        # --show-source: Show the code line with the error
        # --statistics: Report error statistics
        # We ignore F401 (unused import) in __init__.py
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=src/__init__.py

    # Step 5: Test the model self-test
    - name: 5. Test the model script
      run: |
        # Run the self-test in src/model.py to verify shapes
        python src/model.py

    # Step 6: Test data generation
    - name: 6. Test data generation
      run: |
        # Generate a small test dataset
        python scripts/data_generator.py --num-samples 10 --output-dir test_data
        # Generate a test example file
        python scripts/data_generator.py --generate-single test_example.npy

    # Step 7: Test training script (minimal execution)
    - name: 7. Test training script
      run: |
        # Train for a single epoch with test data to ensure the script runs
        # without errors (not to verify accuracy)
        python scripts/train.py --epochs 1 --data-dir test_data